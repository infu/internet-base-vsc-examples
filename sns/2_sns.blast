{"cells":[{"kind":1,"language":"markdown","value":"open ./simple_project\n```\ncd ./simple_project\ndfx deploy\n```\nReplace `can_ids` bellow with the ones you've just deployed and hit play ‚èØ"},{"kind":2,"language":"javascript","value":"const wallet_id = \"qvhpv-4qaaa-aaaaa-aaagq-cai\"; // The reason to use a wallet is to be able to create SNS later, it requires cycles.\nlet can_ids = [\"q4eej-kyaaa-aaaaa-aaaha-cai\", \"q3fc5-haaaa-aaaaa-aaahq-cai\"];\n\n//----\n\nlet local = icblast({ identity, local: true, local_host: \"http://localhost:8080\" });\nlet wallet = await local(wallet_id, \"wallet\");\nlet gov = await local(\"rrkah-fqaaa-aaaaa-aaaaq-cai\");\nlet nns_sns_wasm = await local(\"qaa6y-5yaaa-aaaaa-aaafa-cai\");\nconst ICP = 1_0000_0000;\nconst SNS = 1_0000_0000;\n\nglobal({ local, can_ids, gov, wallet_id, wallet, nns_sns_wasm,ICP, SNS })\n\nlet neurons = await walletProxy(wallet, gov).list_neurons({\n    neuron_ids:[],\n    include_neurons_readable_by_caller:true\n})\n    \nlet my_neuron_id = neurons.full_neurons[0].id.id;\n\nlog(my_neuron_id)\n\nglobal({my_neuron_id})"},{"kind":1,"language":"markdown","value":"### 1 Make proposal to update allowed to create SNS principals \n\nWe are creating a proposal and we send it to the `nns-governance`(rrkah-fqaaa-aaaaa-aaaaq-cai) canister. \n\nIt calls the `nns-sns-wasm`(qaa6y-5yaaa-aaaaa-aaafa-cai) canister's function `update_allowed_principals`"},{"kind":2,"language":"javascript","value":"// Here is the list of NNS function ids https://github.com/dfinity/ic/blob/3695d96de813fe039ab0a533137ad3d5a55836f6/rs/nns/governance/src/gen/ic_nns_governance.pb.v1.rs#L3104\nconst UpdateAllowedPrincipals = 35;\n\n\nawait walletProxy(wallet, gov).manage_neuron({\n  command:{MakeProposal:{\n    url:\"\",\n    title:`ACME - Proposal to enable principal ${me} in SNS-W to initiate the generation of an SNS for ACME`,\n    action:{ExecuteNnsFunction:{\n      nns_function: UpdateAllowedPrincipals,\n      payload: nns_sns_wasm.update_allowed_principals$({ // notice the $, it will make our function return the encoded IDL instead of making a call\n        added_principals:[Principal.fromText(wallet_id)],\n        removed_principals:[]\n        })\n      }},\n    summary:\"Let's enable ACME to generate SNS for ACME\",\n    }},\n  neuron_id_or_subaccount:{NeuronId:{\n    id:my_neuron_id\n    }}\n  }).then(log)\n\n\n\n//https://github.com/dfinity/ic/blob/f8133de73ddc7b7d89e4c8f295309db7ae39eb4a/rs/registry/admin/src/main.rs#L5431"},{"kind":1,"language":"markdown","value":"Run this `dfx ledger fabricate-cycles --canister $(dfx identity get-wallet) --t 2345` to get enough cycles. Making SNSes costs hundreds of $"},{"kind":1,"language":"markdown","value":"### 2 Initialize SNS"},{"kind":2,"language":"javascript","value":"\n\n\n// Explanations here https://github.com/dfinity/snsdemo/blob/3d6e8eafb3a91af41a8df00ed22994c903836487/bin/sns_init.yml#L1\nawait walletProxy(wallet, nns_sns_wasm, 180000000000000).deploy_new_sns({\n  sns_init_payload: {\n    sns_initialization_parameters:\"myparams\",\n    url: \"https://internetbase.org\",\n    max_dissolve_delay_seconds: 1 * 365 * 24 * 60 * 60, //1 year\n    max_dissolve_delay_bonus_percentage: 100,\n    fallback_controller_principal_ids: [wallet_id],\n    token_symbol: \"ACME\",\n    token_name: \"ACME SNS TOKEN\",\n    initial_reward_rate_basis_points: 0, // Like SNS-1, no reward for staking\n    final_reward_rate_basis_points: 0, \n    neuron_minimum_stake_e8s: 1*SNS, //1 SNS\n    logo: \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAIAQMAAAD+wSzIAAAABlBMVEX///+/v7+jQ3Y5AAAADklEQVQI12P4AIX8EAgALgAD/aNpbtEAAAAASUVORK5CYII\",\n    name: \"PROJECT ACME\",\n    initial_voting_period_seconds: 4 * 24 * 60 * 60, // 4 days\n    neuron_minimum_dissolve_delay_to_vote_seconds: 30 * 24 * 60 * 60, // 30 days,\n    description: \"Our awesome ACME SNS\",\n    max_neuron_age_seconds_for_age_bonus: 6 * 30 * 24 * 60 * 60, // 6 months\n    wait_for_quiet_deadline_increase_seconds: 24 * 60 * 60, // 1 day\n    transaction_fee_e8s: 10_000,\n    max_age_bonus_percentage: 0,\n    // sns_initialization_parameters:Text,\n    initial_token_distribution:{FractionalDeveloperVotingPower:{\n      treasury_distribution:{\n        total_e8s: 10_000*SNS\n        },\n      developer_distribution:{\n        developer_neurons:[{\n          controller: Principal.fromText(wallet_id),\n          dissolve_delay_seconds: 30 * 24 * 60 * 60,\n          memo: 0,\n          stake_e8s: 1*SNS\n          }]\n        },\n      airdrop_distribution:{\n        airdrop_neurons:[{\n          controller: hashIdentity(\"johndoe\").getPrincipal(),\n          dissolve_delay_seconds: 0,\n          memo: 0,\n          stake_e8s: 1*SNS\n          }]\n        },\n      swap_distribution:{\n        total_e8s: 30_000*SNS,\n        initial_swap_amount_e8s: 10_000*SNS,\n        }\n      }},\n    reward_rate_transition_duration_seconds: 365 * 24 * 60 * 60, // 1 year\n    proposal_reject_cost_e8s: 10*SNS\n    }\n}).then(log)\n  "},{"kind":1,"language":"markdown","value":"Open the NNS dapp and accept the proposal http://qsgjb-riaaa-aaaaa-aaaga-cai.localhost:8080/\n\nIt will be inside the `Launch Pad` section, not `Voting`"},{"kind":2,"language":"javascript","value":"let resp = await nns_sns_wasm.list_deployed_snses({})\nlog(resp)\n\nconst sns_cans = resp.instances[0]\nglobal({ sns_cans })"},{"kind":1,"language":"markdown","value":"### 3 Give up control\n\ntake the `governance_canister_id` and set it as controller of your two canisters, then remove all other controllers.\n```\ndfx canister update-settings --add-controller st75y-vaaaa-aaaaa-aaalq-cai --all\ndfx canister update-settings --remove-controller `dfx identity get-principal` --all\n```\n\nCheck if the governance canister id is the only controller. If these aren't correct, sns swap will fail later.\n```\ndfx canister status --all\n```\nYou should get error when you run this"},{"kind":1,"language":"markdown","value":"### 4 Propose the SNS decentralization sale"},{"kind":2,"language":"javascript","value":"// Params explained here https://github.com/dfinity/snsdemo/blob/3d6e8eafb3a91af41a8df00ed22994c903836487/bin/dsale.yml#L1\n\nawait walletProxy(wallet, gov).manage_neuron({\n  command:{MakeProposal:{\n    url:\"\",\n    title:\"Start the ACME DAO decentralization sale\",\n    action:{OpenSnsTokenSwap:{\n      community_fund_investment_e8s:100*ICP,\n      target_swap_canister_id: sns_cans.swap_canister_id,\n      params:{\n        swap_due_timestamp_seconds:1687030200,\n        min_participants:1,\n        sns_token_e8s: 10_000*SNS, \n        min_participant_icp_e8s: 1*ICP, \n        max_participant_icp_e8s: 300*ICP, \n        max_icp_e8s:300*ICP, // max to raise\n        min_icp_e8s: 100*ICP, // min to raise\n        neuron_basket_construction_parameters:{\n          dissolve_delay_interval_seconds: 1 * 60 * 60, // 1 hour\n          count:5\n          },\n        }\n      }},\n    summary:\"Let's start swapping\",\n    }},\n  neuron_id_or_subaccount:{NeuronId:{\n    id:my_neuron_id\n    }}\n}).then(log)\n"},{"kind":1,"language":"markdown","value":"### 5 Finalize - Distribute neurons"},{"kind":2,"language":"javascript","value":"let sns_swap = await local(sns_cans.swap_canister_id.toText(), \"https://raw.githubusercontent.com/dfinity/ic-js/a9ed2dea58e62407b64026949692521511407384/packages/sns/candid/sns_swap.did\");\n\nawait sns_swap.finalize_swap({}).then(log);\n"},{"kind":2,"language":"javascript","value":""},{"kind":1,"language":"markdown","value":"### Gratz, you have a DAO!\n\nYou should have ACME DAO neurons in your NNS DAPP\n\nIn the next Blast we will update it's canisters with a proposal"}]}